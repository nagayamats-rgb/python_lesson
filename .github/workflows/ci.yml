# .github/workflows/ci.yml
name: CI

on:
  push:
  pull_request:

jobs:
  lint-and-dryrun:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Upgrade installer
        run: python -m pip install -U pip setuptools wheel

      - name: Install project deps (tolerate extras missing)
        run: |
          pip install -r requirements.txt || true
          pip install python-dotenv pandas requests beautifulsoup4 lxml loguru tqdm pyyaml openpyxl

      - name: List repo (for debugging where files are)
        shell: bash
        run: |
          echo "::group::top level"
          ls -la
          echo "::endgroup::"
          echo "::group::two levels"
          find . -maxdepth 2 -type f | sort
          echo "::endgroup::"

      - name: Dry-run import & files check (no API calls)
        shell: bash
        run: |
          python - <<'PY'
          import os, sys, importlib

          # 探索ルート：直下と python_lesson/ の両にらみ
          ROOTS = [".", "python_lesson"]

          REQUIRED = [
            "crawler_v4_api.py",
            "syntactic_extractor_v3.py",
            "alt_sentence_finalize.py",
            "alt_sentence_clamp.py",
            "sauce/yahoo.csv",
            "sauce/rakuten.csv",
            "sauce/YAHOO_Format.csv",
            "sauce/Rakuten_Format.csv",
          ]

          resolved = {}
          missing = []

          def first_existing(relpath):
            for r in ROOTS:
              p = os.path.join(r, relpath)
              if os.path.exists(p):
                return os.path.normpath(p)
            return None

          for rel in REQUIRED:
            hit = first_existing(rel)
            if hit: resolved[rel] = hit
            else:   missing.append(rel)

          if missing:
            print("MISSING FILES:", ", ".join(missing))
            raise SystemExit(1)

          # .py が格納されているディレクトリを import パスに追加
          py_dir = os.path.dirname(resolved["crawler_v4_api.py"]) or "."
          if py_dir not in sys.path:
            sys.path.insert(0, py_dir)

          for mod in ["crawler_v4_api","syntactic_extractor_v3","alt_sentence_finalize","alt_sentence_clamp"]:
            importlib.import_module(mod)

          print("imports ok")
          PY
